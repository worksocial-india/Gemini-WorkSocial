<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Part Payment Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .input-focus:focus {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px -5px rgba(102, 126, 234, 0.25);
        }
        
        .tab-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .result-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .savings-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="gradient-bg py-8">
        <div class="max-w-6xl mx-auto px-4">
            <h1 class="text-4xl font-bold text-white text-center mb-2">Part Payment Calculator</h1>
            <p class="text-blue-100 text-center">Calculate savings from lump sum or regular additional payments</p>
        </div>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Input Section -->
            <div class="bg-white rounded-2xl card-shadow p-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Loan Details</h2>
                
                <!-- Basic Loan Info -->
                <div class="space-y-6 mb-8">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Loan Amount</label>
                        <input type="number" id="loanAmount" value="500000" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus transition-all duration-200"
                               placeholder="Enter loan amount">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Interest Rate (%)</label>
                            <input type="number" id="interestRate" value="8.5" step="0.1"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus transition-all duration-200"
                                   placeholder="8.5">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Loan Term (Years)</label>
                            <input type="number" id="loanTerm" value="20"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus transition-all duration-200"
                                   placeholder="20">
                        </div>
                    </div>
                </div>

                <!-- Part Payment Type Tabs -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Part Payment Type</h3>
                    <div class="flex bg-gray-100 rounded-lg p-1">
                        <button id="lumpSumTab" class="flex-1 py-3 px-4 rounded-md font-medium transition-all duration-200 tab-active">
                            Lump Sum
                        </button>
                        <button id="regularTab" class="flex-1 py-3 px-4 rounded-md font-medium transition-all duration-200 text-gray-600">
                            Regular Payment
                        </button>
                    </div>
                </div>

                <!-- Lump Sum Options -->
                <div id="lumpSumOptions" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lump Sum Amount</label>
                        <input type="number" id="lumpSumAmount" value="50000"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus transition-all duration-200"
                               placeholder="Enter lump sum amount">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Payment After (Months)</label>
                        <input type="number" id="lumpSumTiming" value="12"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus transition-all duration-200"
                               placeholder="12">
                    </div>
                </div>

                <!-- Regular Payment Options -->
                <div id="regularOptions" class="space-y-6 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Additional Monthly Payment</label>
                        <input type="number" id="regularAmount" value="5000"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus transition-all duration-200"
                               placeholder="Enter additional monthly payment">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Start After (Months)</label>
                            <input type="number" id="regularStartTiming" value="6"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus transition-all duration-200"
                                   placeholder="6">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Duration (Months)</label>
                            <input type="number" id="regularDuration" value="60"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus transition-all duration-200"
                                   placeholder="60">
                        </div>
                    </div>
                </div>

                <button onclick="calculatePartPayment()" 
                        class="w-full mt-8 bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 px-6 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                    Calculate Savings
                </button>

                <!-- Share & Download Options -->
                <div class="mt-6 grid grid-cols-3 gap-3">
                    <button onclick="shareOnWhatsApp()" 
                            class="flex items-center justify-center py-3 px-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all duration-200 text-sm font-medium">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.787"/>
                        </svg>
                        WhatsApp
                    </button>
                    
                    <button onclick="downloadPDF()" 
                            class="flex items-center justify-center py-3 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all duration-200 text-sm font-medium">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        PDF
                    </button>
                    
                    <button onclick="downloadExcel()" 
                            class="flex items-center justify-center py-3 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all duration-200 text-sm font-medium">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Excel
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div class="space-y-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="result-card rounded-2xl p-6 text-white">
                        <h3 class="text-sm font-medium opacity-90 mb-2">Total Interest Saved</h3>
                        <p id="totalSavings" class="text-2xl font-bold">₹0</p>
                    </div>
                    
                    <div class="savings-card rounded-2xl p-6 text-white">
                        <h3 class="text-sm font-medium opacity-90 mb-2">Time Saved</h3>
                        <p id="timeSaved" class="text-2xl font-bold">0 months</p>
                    </div>
                </div>

                <!-- Detailed Results -->
                <div class="bg-white rounded-2xl card-shadow p-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">Comparison</h3>
                    
                    <div class="space-y-6">
                        <!-- Without Part Payment -->
                        <div class="border-l-4 border-red-400 pl-6">
                            <h4 class="font-semibold text-gray-800 mb-3">Without Part Payment</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Monthly EMI:</span>
                                    <span id="originalEMI" class="font-semibold ml-2">₹0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Total Interest:</span>
                                    <span id="originalInterest" class="font-semibold ml-2">₹0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Total Amount:</span>
                                    <span id="originalTotal" class="font-semibold ml-2">₹0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Loan Duration:</span>
                                    <span id="originalDuration" class="font-semibold ml-2">0 months</span>
                                </div>
                            </div>
                        </div>

                        <!-- With Part Payment -->
                        <div class="border-l-4 border-green-400 pl-6">
                            <h4 class="font-semibold text-gray-800 mb-3">With Part Payment</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-600">Monthly EMI:</span>
                                    <span id="newEMI" class="font-semibold ml-2">₹0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Total Interest:</span>
                                    <span id="newInterest" class="font-semibold ml-2">₹0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Total Amount:</span>
                                    <span id="newTotal" class="font-semibold ml-2">₹0</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Loan Duration:</span>
                                    <span id="newDuration" class="font-semibold ml-2">0 months</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Schedule Preview -->
                <div class="bg-white rounded-2xl card-shadow p-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">Payment Schedule Preview</h3>
                    <div id="schedulePreview" class="space-y-3 max-h-64 overflow-y-auto">
                        <p class="text-gray-500 text-center py-8">Calculate to see payment schedule</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables to store calculation results
        let calculationResults = {};
        let fullScheduleData = [];

        // Tab switching functionality
        document.getElementById('lumpSumTab').addEventListener('click', function() {
            switchTab('lumpSum');
        });

        document.getElementById('regularTab').addEventListener('click', function() {
            switchTab('regular');
        });

        function switchTab(type) {
            const lumpSumTab = document.getElementById('lumpSumTab');
            const regularTab = document.getElementById('regularTab');
            const lumpSumOptions = document.getElementById('lumpSumOptions');
            const regularOptions = document.getElementById('regularOptions');

            if (type === 'lumpSum') {
                lumpSumTab.classList.add('tab-active');
                lumpSumTab.classList.remove('text-gray-600');
                regularTab.classList.remove('tab-active');
                regularTab.classList.add('text-gray-600');
                lumpSumOptions.classList.remove('hidden');
                regularOptions.classList.add('hidden');
            } else {
                regularTab.classList.add('tab-active');
                regularTab.classList.remove('text-gray-600');
                lumpSumTab.classList.remove('tab-active');
                lumpSumTab.classList.add('text-gray-600');
                regularOptions.classList.remove('hidden');
                lumpSumOptions.classList.add('hidden');
            }
        }

        function calculateEMI(principal, rate, tenure) {
            const monthlyRate = rate / 12 / 100;
            const emi = (principal * monthlyRate * Math.pow(1 + monthlyRate, tenure)) / 
                       (Math.pow(1 + monthlyRate, tenure) - 1);
            return emi;
        }

        function calculatePartPayment() {
            // Get input values
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value);
            const loanTerm = parseInt(document.getElementById('loanTerm').value);
            const totalMonths = loanTerm * 12;
            
            // Determine payment type
            const isLumpSum = document.getElementById('lumpSumTab').classList.contains('tab-active');
            
            // Calculate original loan details
            const originalEMI = calculateEMI(loanAmount, interestRate, totalMonths);
            const originalTotalAmount = originalEMI * totalMonths;
            const originalInterest = originalTotalAmount - loanAmount;
            
            let newTotalInterest, newDuration, newEMI, scheduleData = [];
            
            if (isLumpSum) {
                const lumpSumAmount = parseFloat(document.getElementById('lumpSumAmount').value);
                const lumpSumTiming = parseInt(document.getElementById('lumpSumTiming').value);
                
                // Calculate with lump sum payment
                const result = calculateWithLumpSum(loanAmount, interestRate, totalMonths, lumpSumAmount, lumpSumTiming);
                newTotalInterest = result.totalInterest;
                newDuration = result.duration;
                newEMI = originalEMI;
                scheduleData = result.schedule;
            } else {
                const regularAmount = parseFloat(document.getElementById('regularAmount').value);
                const regularStartTiming = parseInt(document.getElementById('regularStartTiming').value);
                const regularDuration = parseInt(document.getElementById('regularDuration').value);
                
                // Calculate with regular additional payments
                const result = calculateWithRegularPayments(loanAmount, interestRate, totalMonths, regularAmount, regularStartTiming, regularDuration);
                newTotalInterest = result.totalInterest;
                newDuration = result.duration;
                newEMI = originalEMI;
                scheduleData = result.schedule;
            }
            
            // Calculate savings
            const interestSaved = originalInterest - newTotalInterest;
            const timeSaved = totalMonths - newDuration;
            const newTotalAmount = loanAmount + newTotalInterest;
            
            // Store results globally for sharing/downloading
            calculationResults = {
                loanAmount,
                interestRate,
                loanTerm,
                isLumpSum,
                originalEMI,
                originalInterest,
                originalTotalAmount,
                totalMonths,
                newTotalInterest,
                newDuration,
                newEMI,
                newTotalAmount,
                interestSaved,
                timeSaved,
                paymentType: isLumpSum ? 'Lump Sum' : 'Regular Additional Payment'
            };
            
            fullScheduleData = scheduleData;
            
            // Update display
            document.getElementById('totalSavings').textContent = `₹${Math.round(interestSaved).toLocaleString()}`;
            document.getElementById('timeSaved').textContent = `${timeSaved} months`;
            
            document.getElementById('originalEMI').textContent = `₹${Math.round(originalEMI).toLocaleString()}`;
            document.getElementById('originalInterest').textContent = `₹${Math.round(originalInterest).toLocaleString()}`;
            document.getElementById('originalTotal').textContent = `₹${Math.round(originalTotalAmount).toLocaleString()}`;
            document.getElementById('originalDuration').textContent = `${totalMonths} months`;
            
            document.getElementById('newEMI').textContent = `₹${Math.round(newEMI).toLocaleString()}`;
            document.getElementById('newInterest').textContent = `₹${Math.round(newTotalInterest).toLocaleString()}`;
            document.getElementById('newTotal').textContent = `₹${Math.round(newTotalAmount).toLocaleString()}`;
            document.getElementById('newDuration').textContent = `${newDuration} months`;
            
            // Update schedule preview
            updateSchedulePreview(scheduleData.slice(0, 12)); // Show first 12 months
        }
        
        function calculateWithLumpSum(principal, rate, totalMonths, lumpSum, lumpSumMonth) {
            const monthlyRate = rate / 12 / 100;
            const emi = calculateEMI(principal, rate, totalMonths);
            let balance = principal;
            let totalInterest = 0;
            let month = 0;
            let schedule = [];
            
            while (balance > 0.01 && month < totalMonths * 2) {
                month++;
                const interestPayment = balance * monthlyRate;
                const principalPayment = emi - interestPayment;
                
                totalInterest += interestPayment;
                balance -= principalPayment;
                
                // Apply lump sum payment
                if (month === lumpSumMonth) {
                    balance -= lumpSum;
                    schedule.push({
                        month: month,
                        emi: emi,
                        interest: interestPayment,
                        principal: principalPayment,
                        lumpSum: lumpSum,
                        balance: Math.max(0, balance)
                    });
                } else {
                    schedule.push({
                        month: month,
                        emi: emi,
                        interest: interestPayment,
                        principal: principalPayment,
                        lumpSum: 0,
                        balance: Math.max(0, balance)
                    });
                }
                
                if (balance <= 0) break;
            }
            
            return {
                totalInterest: totalInterest,
                duration: month,
                schedule: schedule
            };
        }
        
        function calculateWithRegularPayments(principal, rate, totalMonths, additionalPayment, startMonth, duration) {
            const monthlyRate = rate / 12 / 100;
            const emi = calculateEMI(principal, rate, totalMonths);
            let balance = principal;
            let totalInterest = 0;
            let month = 0;
            let schedule = [];
            
            while (balance > 0.01 && month < totalMonths * 2) {
                month++;
                const interestPayment = balance * monthlyRate;
                let principalPayment = emi - interestPayment;
                
                // Add additional payment if within the specified period
                let additionalPmt = 0;
                if (month >= startMonth && month < startMonth + duration) {
                    additionalPmt = additionalPayment;
                    principalPayment += additionalPmt;
                }
                
                totalInterest += interestPayment;
                balance -= principalPayment;
                
                schedule.push({
                    month: month,
                    emi: emi,
                    interest: interestPayment,
                    principal: principalPayment - additionalPmt,
                    additional: additionalPmt,
                    balance: Math.max(0, balance)
                });
                
                if (balance <= 0) break;
            }
            
            return {
                totalInterest: totalInterest,
                duration: month,
                schedule: schedule
            };
        }
        
        function updateSchedulePreview(scheduleData) {
            const container = document.getElementById('schedulePreview');
            const isLumpSum = document.getElementById('lumpSumTab').classList.contains('tab-active');
            
            container.innerHTML = scheduleData.map(payment => {
                if (isLumpSum && payment.lumpSum > 0) {
                    return `
                        <div class="flex justify-between items-center py-2 px-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-400">
                            <span class="font-medium">Month ${payment.month}</span>
                            <div class="text-right">
                                <div class="text-sm">EMI: ₹${Math.round(payment.emi).toLocaleString()}</div>
                                <div class="text-sm font-semibold text-yellow-600">Lump Sum: ₹${Math.round(payment.lumpSum).toLocaleString()}</div>
                                <div class="text-xs text-gray-500">Balance: ₹${Math.round(payment.balance).toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                } else if (!isLumpSum && payment.additional > 0) {
                    return `
                        <div class="flex justify-between items-center py-2 px-4 bg-green-50 rounded-lg border-l-4 border-green-400">
                            <span class="font-medium">Month ${payment.month}</span>
                            <div class="text-right">
                                <div class="text-sm">EMI: ₹${Math.round(payment.emi).toLocaleString()}</div>
                                <div class="text-sm font-semibold text-green-600">Additional: ₹${Math.round(payment.additional).toLocaleString()}</div>
                                <div class="text-xs text-gray-500">Balance: ₹${Math.round(payment.balance).toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex justify-between items-center py-2 px-4 bg-gray-50 rounded-lg">
                            <span class="font-medium">Month ${payment.month}</span>
                            <div class="text-right">
                                <div class="text-sm">EMI: ₹${Math.round(payment.emi).toLocaleString()}</div>
                                <div class="text-xs text-gray-500">Balance: ₹${Math.round(payment.balance).toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // WhatsApp Share Function
        function shareOnWhatsApp() {
            if (!calculationResults.loanAmount) {
                alert('Please calculate first before sharing!');
                return;
            }

            const message = `🏦 *Part Payment Calculator Results*

💰 *Loan Details:*
• Loan Amount: ₹${calculationResults.loanAmount.toLocaleString()}
• Interest Rate: ${calculationResults.interestRate}%
• Loan Term: ${calculationResults.loanTerm} years
• Payment Type: ${calculationResults.paymentType}

📊 *Comparison:*
*Without Part Payment:*
• Monthly EMI: ₹${Math.round(calculationResults.originalEMI).toLocaleString()}
• Total Interest: ₹${Math.round(calculationResults.originalInterest).toLocaleString()}
• Duration: ${calculationResults.totalMonths} months

*With Part Payment:*
• Monthly EMI: ₹${Math.round(calculationResults.newEMI).toLocaleString()}
• Total Interest: ₹${Math.round(calculationResults.newTotalInterest).toLocaleString()}
• Duration: ${calculationResults.newDuration} months

💡 *Savings:*
• Interest Saved: ₹${Math.round(calculationResults.interestSaved).toLocaleString()}
• Time Saved: ${calculationResults.timeSaved} months

Calculate your loan savings at: ${window.location.href}`;

            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // PDF Download Function
        function downloadPDF() {
            if (!calculationResults.loanAmount) {
                alert('Please calculate first before downloading!');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Title
            doc.setFontSize(20);
            doc.setTextColor(102, 126, 234);
            doc.text('Part Payment Calculator Report', 20, 30);

            // Loan Details
            doc.setFontSize(16);
            doc.setTextColor(0, 0, 0);
            doc.text('Loan Details:', 20, 50);
            
            doc.setFontSize(12);
            doc.text(`Loan Amount: ₹${calculationResults.loanAmount.toLocaleString()}`, 20, 65);
            doc.text(`Interest Rate: ${calculationResults.interestRate}%`, 20, 75);
            doc.text(`Loan Term: ${calculationResults.loanTerm} years`, 20, 85);
            doc.text(`Payment Type: ${calculationResults.paymentType}`, 20, 95);

            // Comparison
            doc.setFontSize(16);
            doc.text('Comparison:', 20, 115);
            
            doc.setFontSize(14);
            doc.setTextColor(220, 38, 127);
            doc.text('Without Part Payment:', 20, 130);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Monthly EMI: ₹${Math.round(calculationResults.originalEMI).toLocaleString()}`, 25, 145);
            doc.text(`Total Interest: ₹${Math.round(calculationResults.originalInterest).toLocaleString()}`, 25, 155);
            doc.text(`Total Amount: ₹${Math.round(calculationResults.originalTotalAmount).toLocaleString()}`, 25, 165);
            doc.text(`Duration: ${calculationResults.totalMonths} months`, 25, 175);

            doc.setFontSize(14);
            doc.setTextColor(34, 197, 94);
            doc.text('With Part Payment:', 20, 190);
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Monthly EMI: ₹${Math.round(calculationResults.newEMI).toLocaleString()}`, 25, 205);
            doc.text(`Total Interest: ₹${Math.round(calculationResults.newTotalInterest).toLocaleString()}`, 25, 215);
            doc.text(`Total Amount: ₹${Math.round(calculationResults.newTotalAmount).toLocaleString()}`, 25, 225);
            doc.text(`Duration: ${calculationResults.newDuration} months`, 25, 235);

            // Savings
            doc.setFontSize(16);
            doc.setTextColor(79, 172, 254);
            doc.text('Your Savings:', 20, 255);
            
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text(`Interest Saved: ₹${Math.round(calculationResults.interestSaved).toLocaleString()}`, 25, 270);
            doc.text(`Time Saved: ${calculationResults.timeSaved} months`, 25, 280);

            doc.save('part-payment-calculator-report.pdf');
        }

        // Excel Download Function
        function downloadExcel() {
            if (!calculationResults.loanAmount || !fullScheduleData.length) {
                alert('Please calculate first before downloading!');
                return;
            }

            // Create workbook
            const wb = XLSX.utils.book_new();

            // Summary Sheet
            const summaryData = [
                ['Part Payment Calculator Report'],
                [''],
                ['Loan Details'],
                ['Loan Amount', `₹${calculationResults.loanAmount.toLocaleString()}`],
                ['Interest Rate', `${calculationResults.interestRate}%`],
                ['Loan Term', `${calculationResults.loanTerm} years`],
                ['Payment Type', calculationResults.paymentType],
                [''],
                ['Comparison'],
                ['', 'Without Part Payment', 'With Part Payment'],
                ['Monthly EMI', `₹${Math.round(calculationResults.originalEMI).toLocaleString()}`, `₹${Math.round(calculationResults.newEMI).toLocaleString()}`],
                ['Total Interest', `₹${Math.round(calculationResults.originalInterest).toLocaleString()}`, `₹${Math.round(calculationResults.newTotalInterest).toLocaleString()}`],
                ['Total Amount', `₹${Math.round(calculationResults.originalTotalAmount).toLocaleString()}`, `₹${Math.round(calculationResults.newTotalAmount).toLocaleString()}`],
                ['Duration (months)', calculationResults.totalMonths, calculationResults.newDuration],
                [''],
                ['Savings'],
                ['Interest Saved', `₹${Math.round(calculationResults.interestSaved).toLocaleString()}`],
                ['Time Saved', `${calculationResults.timeSaved} months`]
            ];

            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');

            // Payment Schedule Sheet
            const scheduleHeaders = ['Month', 'EMI', 'Interest', 'Principal'];
            if (calculationResults.isLumpSum) {
                scheduleHeaders.push('Lump Sum');
            } else {
                scheduleHeaders.push('Additional Payment');
            }
            scheduleHeaders.push('Balance');

            const scheduleData = [scheduleHeaders];
            
            fullScheduleData.forEach(payment => {
                const row = [
                    payment.month,
                    Math.round(payment.emi),
                    Math.round(payment.interest),
                    Math.round(payment.principal)
                ];
                
                if (calculationResults.isLumpSum) {
                    row.push(Math.round(payment.lumpSum || 0));
                } else {
                    row.push(Math.round(payment.additional || 0));
                }
                
                row.push(Math.round(payment.balance));
                scheduleData.push(row);
            });

            const scheduleWs = XLSX.utils.aoa_to_sheet(scheduleData);
            XLSX.utils.book_append_sheet(wb, scheduleWs, 'Payment Schedule');

            // Download
            XLSX.writeFile(wb, 'part-payment-calculator-report.xlsx');
        }
        
        // Calculate on page load with default values
        calculatePartPayment();
        
        // Add event listeners for real-time calculation
        ['loanAmount', 'interestRate', 'loanTerm', 'lumpSumAmount', 'lumpSumTiming', 'regularAmount', 'regularStartTiming', 'regularDuration'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculatePartPayment);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98081f8fe013197f',t:'MTc1ODEwNzA3Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
